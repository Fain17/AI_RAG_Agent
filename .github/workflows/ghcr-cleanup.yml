name: Cleanup GHCR Images

on:
  push:
    paths:
      - '.github/workflows/ghcr-cleanup.yml'
  schedule:
    - cron: '0 3 * * *'  # Runs daily at 3 AM UTC
  workflow_dispatch:    # Also manually runnable

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install gh and jq
        run: |
          sudo apt-get update
          sudo apt-get install gh jq -y
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"

      - name: Cleanup old GHCR images (keep latest 2)
        run: |
          set -e

          OWNER="Fain17"

          echo "ðŸ“¦ Fetching container packages for user: $OWNER"

          packages=$(gh api -H "Accept: application/vnd.github+json" \
            /users/$OWNER/packages?package_type=container | jq -r '.[].name')

          if [ -z "$packages" ]; then
            echo "âŒ No packages found or failed to fetch packages. Check your GitHub token scopes (needs read:packages & delete:packages)"
            exit 1
          fi

          for package in $packages; do
            echo "ðŸ”„ Processing package: $package"

            versions=$(gh api -H "Accept: application/vnd.github+json" \
              /users/$OWNER/packages/container/$package/versions | jq -r '.[].id')

            if [ -z "$versions" ]; then
              echo "âš ï¸  No versions found for $package â€” skipping."
              continue
            fi

            count=0
            for version in $versions; do
              count=$((count + 1))
              if [ $count -le 2 ]; then
                echo "âœ… Keeping version $version of $package"
              else
                echo "ðŸ—‘ï¸ Deleting version $version of $package"
                gh api --method DELETE -H "Accept: application/vnd.github+json" \
                  /users/$OWNER/packages/container/$package/versions/$version
              fi
            done
          done 