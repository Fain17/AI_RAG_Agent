name: Cleanup GHCR Images

on:
  push:
    paths:
      - '.github/workflows/ghcr-cleanup.yml'
  schedule:
    - cron: '0 3 * * *'  # Runs daily at 3 AM UTC
  workflow_dispatch:    # Also manually runnable

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install gh and jq
        run: |
          sudo apt-get update
          sudo apt-get install gh jq -y
          gh auth login --with-token <<< "${{ secrets.GITHUB_TOKEN }}"

      - name: Cleanup old GHCR images (keep latest 2)
        env:
          OWNER: ${{ github.repository_owner }}
        run: |
          set -e
          echo "Fetching container packages for $OWNER..."
          gh api -H "Accept: application/vnd.github+json" \
            /users/$OWNER/packages?package_type=container | jq -r '.[].name' | while read package; do
            echo "Processing package: $package"
            # Get all versions sorted by creation date (newest first)
            versions=$(gh api -H "Accept: application/vnd.github+json" \
              /users/$OWNER/packages/container/$package/versions | jq -r '.[].id')
            count=0
            for version in $versions; do
              count=$((count+1))
              if [ $count -le 2 ]; then
                echo "Keeping version $version of $package"
              else
                echo "Deleting version $version of $package"
                gh api --method DELETE -H "Accept: application/vnd.github+json" \
                  /users/$OWNER/packages/container/$package/versions/$version
              fi
            done
          done 